<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  body { background: #f8f9fa; font-family: system-ui, sans-serif; margin-bottom: 60px; user-select: none; }
  .container { max-width: 1300px; }
  .tab { cursor: pointer; }
  .tab.active { background: #007bff; color: white; }
  .section { display: none; }
  .section.active { display: block; }
  .status-select { width: 160px; font-weight: bold; }
  .status-present { background: #d4edda !important; color: #155724; }
  .status-late { background: #cfe2ff !important; color: #0d6efd; }
  .status-ontime { background: #d1e7dd !important; color: #198754; }
  .status-absent { background: #f8d7da !important; color: #721c24; }
  .status-casual { background: #fff3cd !important; color: #856404; }
  .status-earned { background: #f8d7da !important; color: #d63384; }
  .debug { background: #e7f3ff; padding: 10px; border-radius: 6px; font-size: 0.9rem; }
  .card { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .badge-present { background: #28a745; }
  .badge-late { background: #0d6efd; }
  .badge-ontime { background: #198754; }
  .badge-absent { background: #dc3545; }
  .badge-casual { background: #ffc107; color: #212529; }
  .badge-earned { background: #d63384; color: white; }
  .top-bar { background: #007bff; color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
  .top-bar .btn { margin: 0 5px; }
  .admin-only { display: none; }
  .logged-in .admin-only { display: inline-block; }
  .login-box { max-width: 400px; margin: 50px auto; }
  .footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #343a40; color: #fff; text-align: center; padding: 12px 0; font-size: 0.9rem; z-index: 1000; }
  .footer a { color: #ffc107; text-decoration: none; }
  canvas { max-height: 300px; }
  .preview-card { border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin: 5px; }
  .print-btn { position: absolute; top: 10px; right: 10px; z-index: 10; }
  .no-print { print-color-adjust: exact; }
  @media print {
    body * { visibility: hidden; }
    .section.active, .section.active * { visibility: visible; }
    .section.active { position: absolute; left: 0; top: 0; width: 100%; }
    .no-print, .top-bar, .footer, .nav-tabs, .print-btn { display: none !important; }
    .table { font-size: 11px; }
    .card { box-shadow: none; border: 1px solid #ddd; margin-bottom: 15px; }
    .badge { font-size: 10px; }
  }
</style>
</head>
<body class="bg-light">

<!-- LOGIN -->
<div id="loginScreen" class="container login-box">
  <div class="card">
    <div class="card-header bg-primary text-white text-center"><h5>Admin Login</h5></div>
    <div class="card-body">
      <div class="mb-3"><label>Username</label><input type="text" id="username" class="form-control" placeholder="Enter username"></div>
      <div class="mb-3"><label>Password</label><input type="password" id="password" class="form-control" placeholder="Enter password"></div>
      <button id="loginBtn" class="btn btn-success w-100">Login</button>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" class="container py-4" style="display:none;">
  <div class="top-bar text-center d-flex justify-content-between align-items-center flex-wrap gap-2 p-3">
    <h4 class="mb-0 text-white">Attendance Management System</h4>
    <div>
      <button id="saveBtn" class="btn btn-success btn-sm">Save All</button>
      <button id="previewBtn" class="btn btn-info btn-sm text-white">Preview</button>
      <button id="downloadBtn" class="btn btn-primary btn-sm">Download Full CSV</button>
      <button id="clearAllBtn" class="btn btn-danger btn-sm admin-only">Clear All</button>
      <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
    </div>
  </div>
  <div class="debug mb-3" id="debug">Ready.</div>

  <!-- Print Button (Visible in all tabs) -->
  <button class="btn btn-secondary btn-sm print-btn no-print" onclick="window.print()">Print This Tab</button>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item"><a class="nav-link tab active" data-tab="attendance">Attendance</a></li>
    <li class="nav-item"><a class="nav-link tab" data-tab="lateontime">Late & On-Time</a></li>
    <li class="nav-item"><a class="nav-link tab" data-tab="dashboard">Dashboard</a></li>
    <li class="nav-item"><a class="nav-link tab" data-tab="empreport">Employee Report</a></li>
    <li class="nav-item"><a class="nav-link tab" data-tab="report">Report</a></li>
    <li class="nav-item"><a class="nav-link tab" data-tab="analytics">Analytics</a></li>
    <li class="nav-item"><a class="nav-link tab admin-only" data-tab="admin">Admin</a></li>
  </ul>

  <!-- ATTENDANCE -->
  <div id="attendance" class="section active">
    <div class="row mb-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Date</label>
        <input type="date" id="attDate" class="form-control" max="">
      </div>
      <div class="col-auto">
        <button id="todayBtn" class="btn btn-outline-primary btn-sm">Today</button>
        <button id="refreshBtn" class="btn btn-outline-secondary btn-sm">Refresh</button>
      </div>
    </div>
    <div class="row g-3 mb-3" id="attPreview"></div>
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr><th>#</th><th>Name</th><th>Scale</th><th>Designation</th><th>Status</th></tr>
        </thead>
        <tbody id="attTable"></tbody>
      </table>
    </div>
  </div>

  <!-- LATE & ON-TIME -->
  <div id="lateontime" class="section">
    <div class="row mb-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Date</label>
        <input type="date" id="lotDate" class="form-control" max="">
      </div>
      <div class="col-auto">
        <button id="lotTodayBtn" class="btn btn-outline-primary btn-sm">Today</button>
        <button id="lotRefreshBtn" class="btn btn-outline-secondary btn-sm">Refresh</button>
        <button id="lotSaveBtn" class="btn btn-success btn-sm">Save & Update</button>
      </div>
    </div>
    <div class="row g-3 mb-3" id="lotPreview"></div>
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr><th>#</th><th>Name</th><th>Scale</th><th>Designation</th><th>Late Status</th></tr>
        </thead>
        <tbody id="lotTable"></tbody>
      </table>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="section">
    <div class="row mb-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Date</label>
        <input type="date" id="dashDate" class="form-control" max="">
      </div>
      <div class="col-auto">
        <button id="dashTodayBtn" class="btn btn-outline-primary btn-sm">Today</button>
        <button id="dashDownloadBtn" class="btn btn-success btn-sm">Download CSV</button>
      </div>
    </div>

    <!-- STAT CARDS -->
    <div class="row g-3 mb-4">
      <div class="col-md-2"><div class="card text-center p-3 bg-success text-white h-100"><h6>Present</h6><h3 id="pCount">0</h3></div></div>
      <div class="col-md-2"><div class="card text-center p-3 bg-warning text-dark h-100"><h6>Casual</h6><h3 id="cCount">0</h3></div></div>
      <div class="col-md-2"><div class="card text-center p-3 bg-danger text-white h-100"><h6>Absent</h6><h3 id="aCount">0</h3></div></div>
      <div class="col-md-2"><div class="card text-center p-3 bg-info text-white h-100"><h6>On-Time</h6><h3 id="otCount">0</h3></div></div>
      <div class="col-md-2"><div class="card text-center p-3 bg-primary text-white h-100"><h6>Late</h6><h3 id="lCount">0</h3></div></div>
      <div class="col-md-2"><div class="card text-center p-3" style="background:#d63384;color:white"><h6>Earned</h6><h3 id="eCount">0</h3></div></div>
    </div>

    <!-- LISTS: Present → Casual → Late → Absent → Earned -->
    <div class="row g-3">
      <div class="col-md-6"><div class="card h-100"><div class="card-header bg-success text-white"><h6>Present</h6></div><div class="card-body p-0"><ul id="pList" class="list-group list-group-flush" style="max-height:320px;overflow:auto"></ul></div></div></div>
      <div class="col-md-6"><div class="card h-100"><div class="card-header bg-warning text-dark"><h6>Casual Leave</h6></div><div class="card-body p-0"><ul id="cList" class="list-group list-group-flush" style="max-height:320px;overflow:auto"></ul></div></div></div>
      <div class="col-md-6"><div class="card h-100"><div class="card-header bg-primary text-white"><h6>Late Comers</h6></div><div class="card-body p-0"><ul id="lateList" class="list-group list-group-flush" style="max-height:320px;overflow:auto"></ul></div></div></div>
      <div class="col-md-6"><div class="card h-100"><div class="card-header bg-danger text-white"><h6>Absent</h6></div><div class="card-body p-0"><ul id="aList" class="list-group list-group-flush" style="max-height:320px;overflow:auto"></ul></div></div></div>
      <div class="col-md-12"><div class="card h-100"><div class="card-header" style="background:#d63384;color:white"><h6>Earned Leave</h6></div><div class="card-body p-0"><ul id="eList" class="list-group list-group-flush" style="max-height:320px;overflow:auto"></ul></div></div></div>
    </div>
  </div>

  <!-- EMPLOYEE REPORT -->
  <div id="empreport" class="section">
    <div class="row mb-4 align-items-end">
      <div class="col-md-4">
        <select id="empSelect" class="form-select"><option value="">-- Select Employee --</option></select>
      </div>
      <div class="col-auto">
        <button id="downloadEmpBtn" class="btn btn-success">Download CSV</button>
      </div>
    </div>
    <div id="empReport"></div>
    <div id="chartContainer" class="mt-4" style="display:none"><canvas id="statusChart"></canvas></div>
  </div>

  <!-- REPORT -->
  <div id="report" class="section">
    <div class="row mb-4 align-items-end">
      <div class="col-md-3"><select id="reportEmpSelect" class="form-select"><option value="">-- All Employees --</option></select></div>
      <div class="col-md-2"><select id="yearSelect" class="form-select"><option value="">All Years</option></select></div>
      <div class="col-md-2">
        <select id="monthSelect" class="form-select">
          <option value="">All Months</option>
          <option value="01">Jan</option><option value="02">Feb</option><option value="03">Mar</option>
          <option value="04">Apr</option><option value="05">May</option><option value="06">Jun</option>
          <option value="07">Jul</option><option value="08">Aug</option><option value="09">Sep</option>
          <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
        </select>
      </div>
      <div class="col-auto">
        <button id="viewReportBtn" class="btn btn-primary">View</button>
        <button id="downloadReportBtn" class="btn btn-success">Download</button>
      </div>
    </div>
    <div id="reportTableContainer"></div>
  </div>

  <!-- ANALYTICS -->
  <div id="analytics" class="section">
    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
      <h5>All Employees - Monthly Summary</h5>
      <div>
        <input type="text" id="analyticsSearch" class="form-control form-control-sm d-inline-block w-auto me-2" placeholder="Search...">
        <button id="excelAnalyticsBtn" class="btn btn-success btn-sm">Excel</button>
        <button id="downloadAnalyticsBtn" class="btn btn-info btn-sm text-white">CSV</button>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-bordered" id="analyticsTable">
        <thead class="table-light">
          <tr><th>Name</th><th>Scale</th><th>Designation</th><th>Month</th><th>Present</th><th>On-Time</th><th>Late</th><th>Absent</th><th>Casual</th><th>Earned</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="admin" class="section">
    <div class="card mb-4">
      <div class="card-header bg-dark text-white"><h5>Add Employee</h5></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4"><input type="text" id="newName" class="form-control" placeholder="Name"></div>
          <div class="col-md-2"><input type="number" id="newScale" class="form-control" placeholder="Scale"></div>
          <div class="col-md-4"><input type="text" id="newDesig" class="form-control" placeholder="Designation"></div>
          <div class="col-md-2"><button id="addEmpBtn" class="btn btn-success w-100">Add</button></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header bg-dark text-white"><h5>Employee List</h5></div>
      <div class="card-body p-0">
        <div id="empList" style="max-height:400px;overflow:auto"></div>
      </div>
    </div>
    <div class="card mt-4">
      <div class="card-header bg-dark text-white"><h5>Restore Backup</h5></div>
      <div class="card-body">
        <input type="file" id="restoreFile" accept=".csv" class="form-control mb-2">
        <button id="restoreBtn" class="btn btn-warning">Restore</button>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<div class="footer">Developed by <a href="#" target="_blank">Syed Rafiq ul Hoda</a> © 2025</div>

<!-- MODALS -->
<div class="modal fade" id="prevModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Preview – <span id="prevTitle"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <div class="table-responsive" style="max-height:60vh">
          <table class="table table-sm table-bordered m-0" id="previewTable">
            <thead class="table-light sticky-top"></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button id="dlDateBtn" class="btn btn-success">Download</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="clearModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Confirm Clear All Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>All attendance, leave, and late records will be permanently deleted.</strong></p>
        <input type="password" id="clearPass" class="form-control" placeholder="Enter password to confirm">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="confirmClearBtn" class="btn btn-danger">Clear All</button>
      </div>
    </div>
  </div>
</div>

<script>
// === DISABLE RIGHT CLICK & F12 ===
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  if (e.key === 'F12' || (e.ctrlKey && ['u','s','a','c'].includes(e.key))) e.preventDefault();
});
// === DATA ===
let employees = JSON.parse(localStorage.getItem('employees')) || [
  {name:"Mr. Safi Ahmad Zakai", scale:20, designation:"Controller of Examination"},
  {name:"Mr. Syed Rafiq Ul Hoda", scale:19, designation:"Controller of Examination"},
  {name:"Ms. Bushra Munir", scale:19, designation:"I.T. Manager (Sr. Scale)"},
  {name:"Mr. Naushad Ahmed", scale:19, designation:"Deputy Controller of Exam."},
  {name:"Mr. Zafar Ali Khan", scale:19, designation:"I.T. Manager (Sr. Scale)"},
  {name:"Mr. Faraz Yar Khan", scale:18, designation:"Deputy Controller of Exam."},
  {name:"Ms. Oufaq Iqbal", scale:18, designation:"I.T. Manager (Sr. Scale)"},
  {name:"Ms. Hira Javvad", scale:18, designation:"I.T. Manager (Jr. Scale)"},
  {name:"Mr. S. M. Kashif", scale:17, designation:"I.T. Manager (Jr. Scale)"},
  {name:"Mr. Syed Muhammad Zubair", scale:17, designation:"Assistant Controller of Exam."},
  {name:"Mr. Irfan Ali Shah", scale:17, designation:"Assistant Controller of Exam."},
  {name:"Mr. Aliyan Bin Saleem", scale:16, designation:"Data Entry Operator"},
  {name:"Mr. Zeeshan Ahmed", scale:16, designation:"Jr. Data Entry Operator"},
  {name:"Mr. Fahad Zeeshan", scale:16, designation:"Jr. Data Entry Operator"},
  {name:"Mr. Arsalan Saeed", scale:16, designation:"Jr. Data Entry Operator"},
  {name:"Mr. Syed Ahad Ali", scale:16, designation:"Senior Data Entry Operator"},
  {name:"Mr. Muhammad Hafeezur Rahman", scale:16, designation:"Jr. Data Entry Operator"},
  {name:"Mr. Khurram Hafeez", scale:16, designation:"Jr. Data Entry Operator"},
  {name:"Mr. Majeed Khan", scale:16, designation:"Jr. Data Entry Operator"},
  {name:"Mr. Mirza Furqan Baig", scale:16, designation:"Data Entry Operator"},
  {name:"Ms. Irfana Ambreen", scale:16, designation:"Jr. Data Entry Operator"},
  {name:"Mr. Tariq Salahuddin", scale:16, designation:"P.A"},
  {name:"Ms. Shazia", scale:16, designation:"Data Entry Operator"},
  {name:"Mr. Muhammad Sohail", scale:15, designation:"Senior Computer Attendant"},
  {name:"Mr. Naveed Shaeikh", scale:15, designation:"Senior Computer Attendant"},
  {name:"Mr. Hafiz Ur Rahman", scale:14, designation:"Senior Computer Attendant"},
  {name:"Mr. Razi Ahmed Abbasi", scale:12, designation:"Computer Attendant"},
  {name:"Ms. Sumreen Sahar", scale:12, designation:"Computer Attendant"},
  {name:"Mr. Muhammad Israr Ahmed", scale:12, designation:"Computer Attendant"},
  {name:"Mr. Muhammad Mazher", scale:12, designation:"Computer Attendant"},
  {name:"Mr. Anfas Ali Shah", scale:12, designation:"Computer Attendant"},
  {name:"Mr. Tauseef Ahmed Khan", scale:12, designation:"Computer Attendant"},
  {name:"Mr. Irfan Ali", scale:12, designation:"Record Keeper"},
  {name:"Mr. Amanatullah", scale:12, designation:"Computer Attendant"},
  {name:"Mr. Muhammad Irshad", scale:12, designation:"Computer Attendant"},
  {name:"Mr. Sajid Hussain", scale:12, designation:"Computer Attendant"},
  {name:"Mr. Saoud Hussain", scale:12, designation:"Computer Attendant"},
  {name:"Mr. Saddam Hussain", scale:6, designation:"Machine Operator"},
  {name:"Mr. Kamran Alam Siddiqui", scale:6, designation:"Machine Operator"},
  {name:"Mr. Shakir Ali", scale:3, designation:"Naib Qasid"},
  {name:"Mr. Rizwan Uz Zaman", scale:3, designation:"Naib Qasid"},
  {name:"Mr. Rao Gee", scale:3, designation:"Naib Qasid"},
  {name:"Mr. Muhammad Junaid Mahfooz Abbasi", scale:3, designation:"Naib Qasid"},
  {name:"Mr. Muhammad Yousuf Khan", scale:3, designation:"Naib Qasid"},
  {name:"Mr. Abdul Khaliq", scale:3, designation:"Lab Attendant"},
  {name:"Mr. Karamatullah Khan", scale:3, designation:"Naib Qasid"},
  {name:"Mr. Fayyaz Sallah Uddin", scale:3, designation:"Naib Qasid"},
  {name:"Mr. Muhammad Aslam", scale:3, designation:"Daftari"},
  {name:"Mr. Karam Dad", scale:3, designation:"Daftari"},
  {name:"Mr. Aurang Zaib", scale:2, designation:"Naib Qasid"},
  {name:"Mr. Naseem Ahmed", scale:2, designation:"Naib Qasid"}
];
let attendanceLog = JSON.parse(localStorage.getItem('attendanceLog')) || [];
let currentDate = '', lotDate = '';
let chart = null;
let currentReportData = null;
let reportData = [];

// === HELPERS ===
function fmt(iso) { const [y,m,d] = iso.split('-'); return `${d}-${m}-${y}`; }
function todayISO() { return new Date().toISOString().slice(0,10); }
function log(msg) { document.getElementById('debug').textContent = msg; }
function setMaxDate() {
  const today = todayISO();
  ['attDate', 'lotDate', 'dashDate'].forEach(id => {
    const el = document.getElementById(id);
    el.max = today;
    if (el.value > today) el.value = today;
  });
}
function saveEmployees() { localStorage.setItem('employees', JSON.stringify(employees)); }

// === LOGIN ===
document.getElementById('loginBtn').onclick = login;
document.getElementById('password').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
function login() {
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value;
  if (u === 'admin' && p === 'admin123') {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.body.classList.add('logged-in');
    initApp();
    log('Logged in.');
  } else alert('Invalid credentials.');
}
document.getElementById('logoutBtn').onclick = () => {
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'block';
  document.body.classList.remove('logged-in');
};

// === INIT ===
function initApp() {
  const today = todayISO();
  setMaxDate();

  const savedAttDate = localStorage.getItem('attDate') || today;
  const savedLotDate = localStorage.getItem('lotDate') || today;
  const savedDashDate = localStorage.getItem('dashDate') || today;

  document.getElementById('attDate').value = savedAttDate;
  document.getElementById('lotDate').value = savedLotDate;
  document.getElementById('dashDate').value = savedDashDate;

  currentDate = savedAttDate;
  lotDate = savedLotDate;

  buildTable();
  buildLotTable();
  updateAttPreview();
  updateLotPreview();
  fillEmployeeDropdowns();
  updateDashboard();
  updateAnalytics();
  updateEmployeeList();
  fillYearFilter();

  document.getElementById('attDate').onchange = () => { currentDate = document.getElementById('attDate').value; localStorage.setItem('attDate', currentDate); buildTable(); updateAttPreview(); };
  document.getElementById('lotDate').onchange = () => { lotDate = document.getElementById('lotDate').value; localStorage.setItem('lotDate', lotDate); buildLotTable(); updateLotPreview(); };
  document.getElementById('dashDate').onchange = () => { localStorage.setItem('dashDate', document.getElementById('dashDate').value); updateDashboard(); };

  document.getElementById('todayBtn').onclick = () => setToday('attDate');
  document.getElementById('refreshBtn').onclick = () => refreshTab('attendance');
  document.getElementById('lotTodayBtn').onclick = () => setToday('lotDate');
  document.getElementById('lotRefreshBtn').onclick = () => refreshTab('lateontime');
  document.getElementById('dashTodayBtn').onclick = () => setToday('dashDate');
  document.getElementById('saveBtn').onclick = saveAll;
  document.getElementById('lotSaveBtn').onclick = saveLotAttendance;
  document.getElementById('previewBtn').onclick = showPreviewModal;
  document.getElementById('downloadBtn').onclick = downloadFullCSV;
  document.getElementById('dashDownloadBtn').onclick = downloadDashboardDate;
  document.getElementById('viewReportBtn').onclick = generateReport;
  document.getElementById('clearAllBtn').onclick = () => new bootstrap.Modal(document.getElementById('clearModal')).show();
  document.getElementById('analyticsSearch').onkeyup = filterAnalytics;
  document.getElementById('excelAnalyticsBtn').onclick = exportToExcel;
  document.getElementById('downloadAnalyticsBtn').onclick = downloadAnalyticsCSV;
  document.getElementById('downloadEmpBtn').onclick = downloadEmployeeReport;
  document.getElementById('downloadReportBtn').onclick = downloadReportCSV;
  document.getElementById('addEmpBtn').onclick = addEmployee;
  document.getElementById('restoreBtn').onclick = restoreBackup;
}

function setToday(id) {
  const today = todayISO();
  document.getElementById(id).value = today;
  localStorage.setItem(id, today);
  if (id === 'attDate') { currentDate = today; buildTable(); updateAttPreview(); }
  if (id === 'lotDate') { lotDate = today; buildLotTable(); updateLotPreview(); }
  if (id === 'dashDate') updateDashboard();
}

function refreshTab(tab) {
  const today = todayISO();
  if (tab === 'attendance') {
    document.getElementById('attDate').value = today;
    currentDate = today;
    localStorage.setItem('attDate', today);
    buildTable(); updateAttPreview();
  }
  if (tab === 'lateontime') {
    document.getElementById('lotDate').value = today;
    lotDate = today;
    localStorage.setItem('lotDate', today);
    buildLotTable(); updateLotPreview();
  }
}

// === CLEAR ALL ===
document.getElementById('confirmClearBtn').onclick = () => {
  if (document.getElementById('clearPass').value === 'admin123') {
    localStorage.removeItem('attendanceLog');
    attendanceLog = [];
    updateAll();
    buildTable(); buildLotTable();
    bootstrap.Modal.getInstance(document.getElementById('clearModal')).hide();
    log('All data cleared permanently.');
  } else alert('Wrong password');
};

// === SAVE ALL ===
function saveAll() { saveAttendance(); saveLotAttendance(); alert('All saved!'); }

// === SAVE ATTENDANCE ===
function saveAttendance() {
  const date = document.getElementById('attDate').value;
  if (!date) return alert('Select date');
  currentDate = date;
  localStorage.setItem('attDate', date);
  attendanceLog = attendanceLog.filter(x => x.date !== date);
  document.querySelectorAll('#attTable tr').forEach(tr => {
    const name = tr.cells[1].textContent;
    const emp = employees.find(e => e.name === name);
    const attStatus = tr.querySelector('select').value;
    attendanceLog.push({ date, name, scale: emp.scale, designation: emp.designation, attStatus, lateStatus: '' });
  });
  localStorage.setItem('attendanceLog', JSON.stringify(attendanceLog));
  updateAll();
}

// === SAVE LATE/ON-TIME ===
function saveLotAttendance() {
  const date = document.getElementById('lotDate').value;
  if (!date) return alert('Select date');
  lotDate = date;
  localStorage.setItem('lotDate', date);
  document.querySelectorAll('#lotTable tr').forEach(tr => {
    const name = tr.cells[1].textContent;
    const select = tr.querySelector('select');
    if (!select.disabled && select.value) {
      const lateStatus = select.value;
      const rec = attendanceLog.find(x => x.date === date && x.name === name);
      if (rec) rec.lateStatus = lateStatus;
    }
  });
  localStorage.setItem('attendanceLog', JSON.stringify(attendanceLog));
  updateAll();
  alert('Late/On-Time updated!');
}

// === TABLES ===
function getStatusClass(s) {
  if (!s) return '';
  return s === 'Present' ? 'status-present' :
         s === 'Late' ? 'status-late' :
         s === 'On-Time' ? 'status-ontime' :
         s === 'Absent' ? 'status-absent' :
         s === 'Casual Leave' ? 'status-casual' : 'status-earned';
}

function buildTable() {
  const tbody = document.getElementById('attTable');
  tbody.innerHTML = '';
  employees.forEach((e, i) => {
    const rec = attendanceLog.find(x => x.date === currentDate && x.name === e.name) || { attStatus: 'Present' };
    const tr = document.createElement('tr');
    tr.className = getStatusClass(rec.attStatus);
    tr.innerHTML = `
      <td>${i+1}</td><td>${e.name}</td><td>${e.scale}</td><td>${e.designation}</td>
      <td><select class="form-select form-select-sm status-select" onchange="updateRowColor(this)">
        <option value="Present" ${rec.attStatus==='Present'?'selected':''}>Present</option>
        <option value="Absent" ${rec.attStatus==='Absent'?'selected':''}>Absent</option>
        <option value="Casual Leave" ${rec.attStatus==='Casual Leave'?'selected':''}>Casual Leave</option>
        <option value="Earned Leave" ${rec.attStatus==='Earned Leave'?'selected':''}>Earned Leave</option>
      </select></td>`;
    tbody.appendChild(tr);
  });
}

function buildLotTable() {
  const tbody = document.getElementById('lotTable');
  tbody.innerHTML = '';
  employees.forEach((e, i) => {
    const rec = attendanceLog.find(x => x.date === lotDate && x.name === e.name) || { attStatus: 'Present', lateStatus: '' };
    const isLeave = ['Absent','Casual Leave','Earned Leave'].includes(rec.attStatus);
    const status = isLeave ? '' : (rec.lateStatus || 'On-Time');
    const disabled = isLeave ? 'disabled' : '';
    const tr = document.createElement('tr');
    tr.className = isLeave ? getStatusClass(rec.attStatus) : getStatusClass(status);
    tr.innerHTML = `
      <td>${i+1}</td><td>${e.name}</td><td>${e.scale}</td><td>${e.designation}</td>
      <td>
        <select class="form-select form-select-sm status-select" ${disabled} onchange="updateRowColor(this)">
          <option value="">--</option>
          <option value="On-Time" ${status==='On-Time'?'selected':''}>On-Time</option>
          <option value="Late" ${status==='Late'?'selected':''}>Late</option>
        </select>
      </td>`;
    tbody.appendChild(tr);
  });
}

function updateRowColor(select) {
  const tr = select.closest('tr');
  const status = select.value || (tr.cells[4].textContent.trim() === '--' ? tr.cells[4].closest('tr').cells[4].querySelector('select').closest('tr').cells[4].textContent.trim() : '');
  tr.className = getStatusClass(status);
}

// === PREVIEW ===
function updateAttPreview() {
  const data = attendanceLog.filter(x => x.date === currentDate);
  const counts = {P:0, A:0, C:0, E:0};
  employees.forEach(emp => {
    const rec = data.find(d => d.name === emp.name);
    const status = rec ? rec.attStatus : 'Present';
    if (status === 'Present') counts.P++;
    else if (status === 'Absent') counts.A++;
    else if (status === 'Casual Leave') counts.C++;
    else if (status === 'Earned Leave') counts.E++;
  });
  const container = document.getElementById('attPreview');
  container.innerHTML = `
    <div class="col"><div class="preview-card bg-success text-white text-center"><h5>${counts.P}</h5><small>Present</small></div></div>
    <div class="col"><div class="preview-card bg-warning text-dark text-center"><h5>${counts.C}</h5><small>Casual</small></div></div>
    <div class="col"><div class="preview-card bg-danger text-white text-center"><h5>${counts.A}</h5><small>Absent</small></div></div>
    <div class="col"><div class="preview-card text-white text-center" style="background:#d63384"><h5>${counts.E}</h5><small>Earned</small></div></div>
  `;
}

function updateLotPreview() {
  const data = attendanceLog.filter(x => x.date === lotDate);
  const counts = {OT:0, L:0};
  employees.forEach(emp => {
    const rec = data.find(d => d.name === emp.name);
    if (rec && !['Absent','Casual Leave','Earned Leave'].includes(rec.attStatus)) {
      if (rec.lateStatus === 'On-Time') counts.OT++;
      else if (rec.lateStatus === 'Late') counts.L++;
    }
  });
  const container = document.getElementById('lotPreview');
  container.innerHTML = `
    <div class="col"><div class="preview-card bg-info text-white text-center"><h5>${counts.OT}</h5><small>On-Time</small></div></div>
    <div class="col"><div class="preview-card bg-primary text-white text-center"><h5>${counts.L}</h5><small>Late</small></div></div>
  `;
}

// === TABS ===
document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
  document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.section').forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  document.getElementById(t.dataset.tab).classList.add('active');
  if (t.dataset.tab === 'dashboard') updateDashboard();
  if (t.dataset.tab === 'analytics') updateAnalytics();
  if (t.dataset.tab === 'admin') updateEmployeeList();
  if (t.dataset.tab === 'report') { fillEmployeeDropdowns(); fillYearFilter(); }
  if (t.dataset.tab === 'empreport') fillEmployeeDropdowns();
  if (t.dataset.tab === 'lateontime') { buildLotTable(); updateLotPreview(); }
  if (t.dataset.tab === 'attendance') { buildTable(); updateAttPreview(); }
});

// === UPDATE ALL ===
function updateAll() {
  updateDashboard();
  updateAnalytics();
  updateAttPreview();
  updateLotPreview();
  fillYearFilter();
}

// === DASHBOARD ===
function updateDashboard() {
  const date = document.getElementById('dashDate').value || todayISO();
  localStorage.setItem('dashDate', date);
  const data = attendanceLog.filter(x => x.date === date);
  const counts = {P:0, OT:0, L:0, A:0, C:0, E:0};
  const lists = {P:[], OT:[], L:[], A:[], C:[], E:[]};

  employees.forEach(emp => {
    const rec = data.find(d => d.name === emp.name) || { attStatus: 'Absent', lateStatus: '' };
    const att = rec.attStatus;
    const late = rec.lateStatus;

    if (att === 'Present') {
      counts.P++;
      if (late === 'On-Time') { counts.OT++; lists.OT.push(emp.name); }
      else if (late === 'Late') { counts.L++; lists.L.push(emp.name); }
      lists.P.push(emp.name);
    } else if (att === 'Absent') { counts.A++; lists.A.push(emp.name); }
    else if (att === 'Casual Leave') { counts.C++; lists.C.push(emp.name); }
    else if (att === 'Earned Leave') { counts.E++; lists.E.push(emp.name); }
  });

  document.getElementById('pCount').textContent = counts.P;
  document.getElementById('otCount').textContent = counts.OT;
  document.getElementById('lCount').textContent = counts.L;
  document.getElementById('aCount').textContent = counts.A;
  document.getElementById('cCount').textContent = counts.C;
  document.getElementById('eCount').textContent = counts.E;

  const listHTML = (arr) => arr.length ? arr.map(n => `<li class="list-group-item">${n}</li>`).join('') : '<li class="list-group-item text-muted text-center">— None —</li>';
  document.getElementById('pList').innerHTML = listHTML(lists.P);
  document.getElementById('cList').innerHTML = listHTML(lists.C);
  document.getElementById('lateList').innerHTML = listHTML(lists.L);
  document.getElementById('aList').innerHTML = listHTML(lists.A);
  document.getElementById('eList').innerHTML = listHTML(lists.E);
}

// === CSV DOWNLOADS ===
function downloadCSV(csv, name) {
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = name;
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function downloadFullCSV() {
  let csv = `Date,Name,Scale,Designation,Attendance Status,Late Status\n`;
  attendanceLog.forEach(r => {
    csv += `"${fmt(r.date)}","${r.name}","${r.scale}","${r.designation}","${r.attStatus}","${r.lateStatus}"\n`;
  });
  downloadCSV(csv, `Full_Backup_${todayISO()}.csv`);
}

function downloadDashboardDate() {
  const date = document.getElementById('dashDate').value;
  if (!date) return alert('Select date');
  const data = attendanceLog.filter(x => x.date === date);
  let csv = `Date,Name,Scale,Designation,Attendance Status,Late Status\n`;
  data.forEach(r => {
    csv += `"${fmt(r.date)}","${r.name}","${r.scale}","${r.designation}","${r.attStatus}","${r.lateStatus}"\n`;
  });
  downloadCSV(csv, `Attendance_${date}.csv`);
}

// === RESTORE BACKUP ===
function restoreBackup() {
  const file = document.getElementById('restoreFile').files[0];
  if (!file) return alert('Select file');
  const reader = new FileReader();
  reader.onload = e => {
    const lines = e.target.result.trim().split('\n').slice(1);
    const restored = [];
    lines.forEach(line => {
      const parts = line.replace(/"/g,'').split(',');
      if (parts.length >= 6) {
        const [date, name, scale, desig, attStatus, lateStatus] = parts;
        if (date && name && attStatus) {
          restored.push({ date, name, scale: parseInt(scale), designation: desig, attStatus, lateStatus });
        }
      }
    });
    attendanceLog = restored;
    localStorage.setItem('attendanceLog', JSON.stringify(attendanceLog));
    updateAll();
    alert('Backup restored!');
  };
  reader.readAsText(file);
}

// === EMPLOYEE REPORT ===
function fillEmployeeDropdowns() {
  ['empSelect', 'reportEmpSelect'].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = id === 'empSelect' ? '<option value="">-- Select Employee --</option>' : '<option value="">-- All Employees --</option>';
    employees.forEach(e => {
      const opt = document.createElement('option');
      opt.value = e.name;
      opt.textContent = e.name;
      sel.appendChild(opt);
    });
  });
  document.getElementById('empSelect').onchange = viewEmployeeReport;
}

function viewEmployeeReport() {
  const name = document.getElementById('empSelect').value;
  if (!name) {
    document.getElementById('empReport').innerHTML = '';
    document.getElementById('chartContainer').style.display = 'none';
    return;
  }
  const hist = attendanceLog.filter(x => x.name === name).sort((a,b) => a.date.localeCompare(b.date));
  let p=0, ot=0, l=0, a=0, c=0, e=0;
  hist.forEach(h => {
    if (h.attStatus === 'Present' && h.lateStatus === 'On-Time') ot++;
    else if (h.attStatus === 'Present' && h.lateStatus === 'Late') l++;
    else if (h.attStatus === 'Present') p++;
    else if (h.attStatus === 'Absent') a++;
    else if (h.attStatus === 'Casual Leave') c++;
    else if (h.attStatus === 'Earned Leave') e++;
  });
  p += ot + l;
  currentReportData = { hist, p, ot, l, a, c, e, name };
  const report = `<div class="card"><div class="card-header bg-primary text-white"><h5>${name} - History</h5></div><div class="card-body">
    <div class="row text-center mb-3 g-2">
      <div class="col"><span class="badge badge-present fs-5 p-2">${p} Present</span></div>
      <div class="col"><span class="badge bg-info text-white fs-5 p-2">${ot} On-Time</span></div>
      <div class="col"><span class="badge bg-primary fs-5 p-2">${l} Late</span></div>
      <div class="col"><span class="badge badge-absent fs-5 p-2">${a} Absent</span></div>
      <div class="col"><span class="badge badge-casual fs-5 p-2">${c} Casual</span></div>
      <div class="col"><span class="badge badge-earned fs-5 p-2">${e} Earned</span></div>
    </div>
    <h6>History</h6><div style="max-height:400px;overflow:auto;">${hist.map(h=>`<div><small class="text-muted">${fmt(h.date)}</small> <strong class="badge ${getBadgeClass(h.lateStatus)}">${h.attStatus} (${h.lateStatus||'--'})</strong></div>`).join('')||'<em>No records</em>'}</div></div></div>`;
  document.getElementById('empReport').innerHTML = report;
  document.getElementById('chartContainer').style.display = 'block';
  const ctx = document.getElementById('statusChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Present', 'On-Time', 'Late', 'Absent', 'Casual', 'Earned'],
      datasets: [{ label: 'Count', data: [p, ot, l, a, c, e], backgroundColor: ['#28a745', '#17a2b8', '#007bff', '#dc3545', '#ffc107', '#d63384'], borderWidth: 1 }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

function downloadEmployeeReport() {
  if (!currentReportData) return alert('Select employee');
  const { hist, name } = currentReportData;
  let csv = `Date,Name,Scale,Designation,Attendance Status,Late Status\n`;
  hist.forEach(r => csv += `"${fmt(r.date)}","${r.name}","${r.scale}","${r.designation}","${r.attStatus}","${r.lateStatus}"\n`);
  downloadCSV(csv, `${name.replace(/ /g,'_')}_Report.csv`);
}

// === REPORT ===
function generateReport() {
  const emp = document.getElementById('reportEmpSelect').value;
  const year = document.getElementById('yearSelect').value;
  const month = document.getElementById('monthSelect').value;
  let filtered = attendanceLog;
  if (emp) filtered = filtered.filter(x => x.name === emp);
  if (year) filtered = filtered.filter(x => x.date.startsWith(year));
  if (month) filtered = filtered.filter(x => x.date.startsWith(`${year}-${month}`));
  const summary = {};
  filtered.forEach(e => {
    const key = e.name;
    if (!summary[key]) summary[key] = {P:0,OT:0,L:0,A:0,C:0,E:0};
    if (e.attStatus === 'Present' && e.lateStatus === 'On-Time') summary[key].OT++;
    else if (e.attStatus === 'Present' && e.lateStatus === 'Late') summary[key].L++;
    else if (e.attStatus === 'Present') summary[key].P++;
    else if (e.attStatus === 'Absent') summary[key].A++;
    else if (e.attStatus === 'Casual Leave') summary[key].C++;
    else if (e.attStatus === 'Earned Leave') summary[key].E++;
  });
  reportData = (emp ? [employees.find(x=>x.name===emp)] : employees).map(emp => {
    const s = summary[emp.name] || {P:0,OT:0,L:0,A:0,C:0,E:0};
    s.P += s.OT + s.L;
    return { ...emp, ...s };
  });
  const container = document.getElementById('reportTableContainer');
  container.innerHTML = `
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5>Summary - ${emp||'All'} ${year||''} ${month?getMonthName(month):''}</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-bordered mb-0">
            <thead class="table-light">
              <tr><th>Name</th><th>Scale</th><th>Designation</th><th>Present</th><th>On-Time</th><th>Late</th><th>Absent</th><th>Casual</th><th>Earned</th></tr>
            </thead>
            <tbody>
              ${reportData.map(r => `
                <tr>
                  <td>${r.name}</td>
                  <td>${r.scale}</td>
                  <td>${r.designation}</td>
                  <td><span class="badge badge-present">${r.P}</span></td>
                  <td><span class="badge bg-info text-white">${r.OT}</span></td>
                  <td><span class="badge bg-primary">${r.L}</span></td>
                  <td><span class="badge badge-absent">${r.A}</span></td>
                  <td><span class="badge badge-casual">${r.C}</span></td>
                  <td><span class="badge badge-earned">${r.E}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>`;
}

function getMonthName(m) {
  const names = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return names[parseInt(m)];
}

function downloadReportCSV() {
  if (!reportData.length) return alert('Generate report');
  let csv = `Name,Scale,Designation,Present,On-Time,Late,Absent,Casual,Earned\n`;
  reportData.forEach(r => csv += `"${r.name}","${r.scale}","${r.designation}","${r.P}","${r.OT}","${r.L}","${r.A}","${r.C}","${r.E}"\n`);
  downloadCSV(csv, `Report_${todayISO()}.csv`);
}

// === ANALYTICS ===
function fillYearFilter() {
  const years = new Set(attendanceLog.map(x => x.date.substring(0,4)));
  const sel = document.getElementById('yearSelect');
  sel.innerHTML = '<option value="">All Years</option>';
  [...years].sort().reverse().forEach(y => {
    const opt = document.createElement('option'); opt.value = y; opt.textContent = y; sel.appendChild(opt);
  });
}

let analyticsData = [];
function updateAnalytics() {
  const months = new Set(attendanceLog.map(x => x.date.substring(0,7)));
  const monthly = {};
  employees.forEach(emp => {
    months.forEach(m => {
      const key = `${m}_${emp.name}`;
      if (!monthly[key]) monthly[key] = {P:0,OT:0,L:0,A:0,C:0,E:0};
    });
  });
  attendanceLog.forEach(e => {
    const m = e.date.substring(0,7);
    const key = `${m}_${e.name}`;
    if (!monthly[key]) monthly[key] = {P:0,OT:0,L:0,A:0,C:0,E:0};
    if (e.attStatus === 'Present' && e.lateStatus === 'On-Time') monthly[key].OT++;
    else if (e.attStatus === 'Present' && e.lateStatus === 'Late') monthly[key].L++;
    else if (e.attStatus === 'Present') monthly[key].P++;
    else if (e.attStatus === 'Absent') monthly[key].A++;
    else if (e.attStatus === 'Casual Leave') monthly[key].C++;
    else if (e.attStatus === 'Earned Leave') monthly[key].E++;
  });
  analyticsData = [];
  const tbody = document.getElementById('analyticsTable').querySelector('tbody');
  tbody.innerHTML = '';
  [...months].sort().reverse().forEach(m => {
    employees.forEach(emp => {
      const key = `${m}_${emp.name}`;
      const c = monthly[key] || {P:0,OT:0,L:0,A:0,C:0,E:0};
      c.P += c.OT + c.L;
      const row = {name:emp.name, scale:emp.scale, designation:emp.designation, month:m.replace('-','/'), P:c.P, OT:c.OT, L:c.L, A:c.A, C:c.C, E:c.E};
      analyticsData.push(row);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${emp.name}</td><td>${emp.scale}</td><td>${emp.designation}</td><td>${m.replace('-','/')}</td><td>${c.P}</td><td>${c.OT}</td><td>${c.L}</td><td>${c.A}</td><td>${c.C}</td><td>${c.E}</td>`;
      tbody.appendChild(tr);
    });
  });
}

function filterAnalytics() {
  const term = document.getElementById('analyticsSearch').value.toLowerCase();
  document.querySelectorAll('#analyticsTable tbody tr').forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
  });
}

function exportToExcel() {
  const ws = XLSX.utils.json_to_sheet(analyticsData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Analytics");
  XLSX.writeFile(wb, "Monthly_Analytics.xlsx");
}

function downloadAnalyticsCSV() {
  let csv = `Monthly Summary\nName,Scale,Designation,Month,Present,On-Time,Late,Absent,Casual,Earned\n`;
  analyticsData.forEach(r => csv += `"${r.name}","${r.scale}","${r.designation}","${r.month}","${r.P}","${r.OT}","${r.L}","${r.A}","${r.C}","${r.E}"\n`);
  downloadCSV(csv, `Analytics_${todayISO()}.csv`);
}

// === ADMIN ===
function addEmployee() {
  const name = document.getElementById('newName').value.trim();
  const scale = document.getElementById('newScale').value;
  const desig = document.getElementById('newDesig').value.trim();
  if (!name || !scale || !desig) return alert('Fill all');
  if (employees.some(e => e.name === name)) return alert('Employee exists');
  employees.push({ name, scale: parseInt(scale), designation: desig });
  saveEmployees();
  buildTable(); buildLotTable(); fillEmployeeDropdowns(); updateAnalytics(); updateDashboard(); updateEmployeeList();
  document.getElementById('newName').value = document.getElementById('newScale').value = document.getElementById('newDesig').value = '';
}

function updateEmployeeList() {
  const container = document.getElementById('empList');
  container.innerHTML = '';
  employees.forEach((e, i) => {
    const div = document.createElement('div');
    div.className = 'p-2 border-bottom d-flex justify-content-between align-items-center';
    div.innerHTML = `<div><strong>${e.name}</strong> <small class="text-muted">Scale ${e.scale} - ${e.designation}</small></div>
      <div>
        <button class="btn btn-sm btn-warning edit-btn" data-index="${i}">Edit</button>
        <button class="btn btn-sm btn-danger delete-btn" data-index="${i}">Delete</button>
      </div>`;
    container.appendChild(div);
  });
  container.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => {
    if (confirm('Delete employee?')) {
      employees.splice(btn.dataset.index, 1);
      saveEmployees();
      buildTable(); buildLotTable(); fillEmployeeDropdowns(); updateAnalytics(); updateDashboard(); updateEmployeeList();
    }
  });
  container.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = () => {
    const idx = btn.dataset.index;
    const emp = employees[idx];
    const n = prompt('Name:', emp.name);
    const s = prompt('Scale:', emp.scale);
    const d = prompt('Designation:', emp.designation);
    if (n && s && d) {
      employees[idx] = {name:n, scale:parseInt(s), designation:d};
      saveEmployees();
      buildTable(); buildLotTable(); fillEmployeeDropdowns(); updateAnalytics(); updateDashboard(); updateEmployeeList();
    }
  });
}

// === PREVIEW MODAL ===
function showPreviewModal() {
  const date = currentDate || todayISO();
  const data = attendanceLog.filter(x => x.date === date);
  document.getElementById('prevTitle').textContent = fmt(date);
  const thead = document.querySelector('#previewTable thead');
  const tbody = document.querySelector('#previewTable tbody');
  thead.innerHTML = '<tr><th>#</th><th>Name</th><th>Scale</th><th>Designation</th><th>Attendance Status</th><th>Late Status</th></tr>';
  tbody.innerHTML = '';
  data.forEach((e, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${e.name}</td><td>${e.scale}</td><td>${e.designation}</td><td><span class="badge ${getBadgeClass(e.attStatus)}">${e.attStatus}</span></td><td><span class="badge ${getBadgeClass(e.lateStatus)}">${e.lateStatus||'--'}</span></td>`;
    tbody.appendChild(tr);
  });
  const modal = new bootstrap.Modal(document.getElementById('prevModal'));
  modal.show();
  document.getElementById('dlDateBtn').onclick = downloadDashboardDate;
}

// === BADGE CLASS ===
function getBadgeClass(s) {
  if (!s || s === '--') return 'bg-secondary';
  return s === 'Present' ? 'badge-present' :
         s === 'Late' ? 'badge-late' :
         s === 'On-Time' ? 'bg-info text-white' :
         s === 'Absent' ? 'badge-absent' :
         s === 'Casual Leave' ? 'badge-casual' : 'badge-earned';
}

window.onload = () => {
  setMaxDate();
  if (document.body.classList.contains('logged-in')) initApp();
};
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
